import { PrismaClient } from '@prisma/client'
import { TopicContent } from '../src/types/topic-content'
import { getTopicImagesFromMCP } from '../src/services/mcp-client'

const prisma = new PrismaClient()

async function main() {
  console.log('üå± Iniciando seed...')

  // 1. Crear Carrera de SSO
  const ssoCareer = await prisma.career.upsert({
    where: { slug: 'sso' },
    update: {},
    create: {
      name: 'Seguridad y Salud Ocupacional',
      slug: 'sso',
      description: 'Carrera t√©cnica en Seguridad y Salud Ocupacional seg√∫n normativa peruana',
      icon: 'ü¶∫',
      color: '#FF6B35',
      durationMonths: 12,
      level: 'T√©cnico',
      isActive: true
    }
  })

  console.log('‚úÖ Carrera SSO creada')

  // 2. Crear Instructor IA de SSO
  const ssoInstructor = await prisma.aIInstructor.upsert({
    where: { id: 'instructor_sso_001' },
    update: {},
    create: {
      id: 'instructor_sso_001',
      name: 'Prof. Claude - Instructor de SSO',
      specialty: 'Seguridad y Salud Ocupacional',
      bio: 'Instructor especializado en normativa peruana de seguridad y salud en el trabajo. Experto en IPERC, Ley 29783 y gesti√≥n de riesgos laborales.',
      avatar: 'üßë‚Äçüè´',
      systemPromptBase: 'Eres un instructor experto en Seguridad y Salud Ocupacional con conocimiento profundo de la normativa peruana.',
      temperature: 0.7,
      maxTokens: 2048,
      expertiseAreas: ['Ley 29783', 'IPERC', 'ISO 45001', 'Planes de Seguridad'],
      tone: 'Profesional, emp√°tico y motivador',
      isActive: true
    }
  })

  console.log('‚úÖ Instructor SSO creado')

  // 3. Crear Curso de Fundamentos
  const fundamentosCourse = await prisma.course.upsert({
    where: { slug: 'fundamentos-sso' },
    update: {},
    create: {
      title: 'Fundamentos de Seguridad y Salud Ocupacional',
      slug: 'fundamentos-sso',
      description: 'Curso introductorio a la SSO seg√∫n normativa peruana',
      type: 'CAREER',
      careerId: ssoCareer.id,
      order: 1,
      isPublished: true
    }
  })

  console.log('‚úÖ Curso Fundamentos creado')

  // 4. Crear Tema IPERC con contenido completo (estructura simplificada)
  const ipercContent: TopicContent = {
    topic: {
      id: 'topic_iperc_001',
      title: 'IPERC - Identificaci√≥n de Peligros, Evaluaci√≥n y Control de Riesgos',
      learning_objective: 'El estudiante comprender√° y aplicar√° la metodolog√≠a IPERC para identificar peligros, evaluar riesgos y establecer controles seg√∫n la Ley 29783 de Seguridad y Salud en el Trabajo del Per√∫',
      expected_learning: 'Al finalizar este tema, el estudiante ser√° capaz de realizar una matriz IPERC b√°sica identificando peligros, evaluando riesgos y proponiendo controles jer√°rquicos',
      key_points: [
        'Identificaci√≥n de peligros en el √°rea de trabajo',
        'Evaluaci√≥n de riesgos usando matriz de probabilidad y severidad',
        'Determinaci√≥n de controles seg√∫n jerarqu√≠a',
        'Cumplimiento de la Ley 29783'
      ],
      moments: [
        {
          id: 'moment_001',
          title: 'Conceptos Fundamentales del IPERC',
          order: 1,
          description: 'Introducci√≥n a peligros y riesgos',
          activities: [
            {
              id: 'activity_001',
              type: 'explanation',
              complexity: 'simple',
              teaching: {
                agent_instruction: 'Explica de forma concisa qu√© es IPERC y la diferencia fundamental entre PELIGRO (fuente de da√±o, algo que ya existe - ejemplo: piso mojado, cable pelado) y RIESGO (probabilidad de que ese peligro cause da√±o - ejemplo: probabilidad de resbalarse, probabilidad de electrocutarse). Enfatiza que IPERC es la metodolog√≠a sistem√°tica usada en Per√∫ (Ley 29783) para identificar peligros, evaluar riesgos y establecer controles. Luego presenta un caso pr√°ctico con m√∫ltiples peligros para que el estudiante aplique los conceptos.',
                target_length: '200-300 palabras',
                context: 'Normativa: Ley 29783. Pa√≠s: Per√∫. Sector: General'
              },
              verification: {
                question: 'Analiza esta situaci√≥n de un TALLER MEC√ÅNICO:\n\n"En el √°rea de trabajo hay m√°quinas con partes m√≥viles expuestas, piso con manchas de aceite, cables el√©ctricos deteriorados cruzando el pasillo, y ruido constante de m√°s de 85 decibeles."\n\nTarea:\n1. Identifica TRES PELIGROS espec√≠ficos que observas en este escenario\n2. Para cada peligro, explica cu√°l ser√≠a el RIESGO asociado (¬øqu√© da√±o podr√≠a ocurrir? ¬øqu√© tan probable es?)\n3. Explica con tus palabras: ¬øcu√°l es la diferencia entre peligro y riesgo?\n\nFormato: "Peligro: [X] ‚Üí Riesgo: [probabilidad de Y da√±o]"'
              },
              metadata: {
                estimated_minutes: 10,
                difficulty: 'easy',
                max_reprompts: 3
              }
            }
          ]
        },
        {
          id: 'moment_002',
          title: 'Identificaci√≥n de Peligros',
          order: 2,
          description: 'Aprende a identificar los 7 tipos de peligros laborales',
          activities: [
            {
              id: 'activity_002',
              type: 'explanation',
              complexity: 'simple',
              teaching: {
                agent_instruction: 'Explica brevemente los 7 tipos de peligros laborales seg√∫n normativa peruana: MEC√ÅNICOS (m√°quinas, herramientas, veh√≠culos), F√çSICOS (ruido, vibraci√≥n, temperatura, iluminaci√≥n), QU√çMICOS (gases, polvos, solventes), BIOL√ìGICOS (virus, bacterias, hongos), ERGON√ìMICOS (posturas, movimientos repetitivos, cargas), PSICOSOCIALES (estr√©s, hostigamiento, carga mental), LOCATIVOS (pisos, escaleras, techos, espacios confinados). Muestra la imagen con los 7 tipos para que el estudiante tenga una referencia visual. Luego presenta el caso del taller de soldadura con m√∫ltiples peligros simult√°neos.',
                target_length: '250-350 palabras',
                context: 'Normativa: Ley 29783, DS 005-2012-TR. Pa√≠s: Per√∫',
                suggested_image_ids: ['iperc-tipos-riesgos-laborales', 'iperc-caso-soldadura-corte']
              },
              verification: {
                question: 'Observa la [VER IMAGEN: Caso Pr√°ctico: Trabajo de Soldadura y Corte]\n\nAnaliza el TALLER DE SOLDADURA mostrado en la imagen:\n\nTarea:\n1. Identifica AL MENOS 5 peligros espec√≠ficos que observas en la imagen\n2. Clasifica cada uno por tipo usando los 7 tipos: Mec√°nico, F√≠sico, Qu√≠mico, Biol√≥gico, Ergon√≥mico, Psicosocial o Locativo\n3. Para cada peligro, explica EN UNA L√çNEA por qu√© pertenece a esa categor√≠a\n\nFormato:\n"Peligro 1: [descripci√≥n] - Tipo: [X] - Raz√≥n: [porque...]"\n"Peligro 2: [descripci√≥n] - Tipo: [Y] - Raz√≥n: [porque...]"\n...'
              },
              metadata: {
                estimated_minutes: 12,
                difficulty: 'medium',
                max_reprompts: 3
              }
            }
          ]
        },
        {
          id: 'moment_003',
          title: 'Evaluaci√≥n de Riesgos',
          order: 3,
          description: 'Aprende a evaluar riesgos usando la matriz 5√ó5',
          activities: [
            {
              id: 'activity_003',
              type: 'explanation',
              complexity: 'moderate',
              teaching: {
                agent_instruction: 'Explica la Matriz de Evaluaci√≥n de Riesgos 5√ó5 mostrada en la imagen. Detalla c√≥mo funciona: eje vertical = SEVERIDAD (Catastr√≥fico=1, Mortalidad=2, Permanente=3, Temporal=4, Menor=5), eje horizontal = FRECUENCIA (Com√∫n=A, Ha sucedido=B, Podr√≠a suceder=C, Raro=D, Imposible=E). Al cruzarlos obtienes un n√∫mero (1-25) que indica el nivel de riesgo. C√≥digo de colores: ROJO (1-6: intolerable, acci√≥n inmediata), AMARILLO (7-14: tolerable con control, revisar peri√≥dicamente), VERDE (15-25: aceptable, mantener controles). Luego presenta casos pr√°cticos para que el estudiante eval√∫e usando la matriz.',
                target_length: '300-400 palabras',
                context: 'Normativa: Ley 29783. M√©todo: Matriz 5√ó5. Pa√≠s: Per√∫',
                suggested_image_ids: ['iperc-matriz-evaluacion-5x5']
              },
              verification: {
                question: 'Usa la [VER IMAGEN: Matriz de Evaluaci√≥n de Riesgos 5√ó5] para evaluar estos 3 peligros:\n\nPELIGRO 1: "Proyecci√≥n de chispas durante soldadura"\n‚Ä¢ Frecuencia: Ocurre frecuentemente, casi todos los d√≠as\n‚Ä¢ Da√±o potencial: Quemaduras leves en piel y ojos\n\nPELIGRO 2: "Ca√≠da desde andamio de 8 metros de altura sin arn√©s"\n‚Ä¢ Frecuencia: Poco frecuente, solo 2 veces al mes se usa el andamio\n‚Ä¢ Da√±o potencial: Muerte o lesiones permanentes (paraplejia)\n\nPELIGRO 3: "Trabajo sentado prolongado en oficina (8 horas)"\n‚Ä¢ Frecuencia: Todos los d√≠as laborales\n‚Ä¢ Da√±o potencial: Dolores lumbares, molestias temporales\n\nPara cada peligro:\n1. Determina SEVERIDAD (1-5) seg√∫n la matriz\n2. Determina FRECUENCIA (A-E) seg√∫n la matriz\n3. Encuentra el N√öMERO resultante en la matriz (1-25)\n4. Indica el COLOR (rojo/amarillo/verde) y NIVEL DE RIESGO (intolerable/tolerable/aceptable)\n5. ¬øCu√°l de los 3 peligros es el M√ÅS CR√çTICO y por qu√©?\n\nFormato:\n"Peligro 1: Severidad=X, Frecuencia=Y, N√∫mero=Z, Color=[color], Nivel=[nivel]"'
              },
              metadata: {
                estimated_minutes: 15,
                difficulty: 'medium',
                max_reprompts: 3
              }
            }
          ]
        },
        {
          id: 'moment_004',
          title: 'Determinaci√≥n de Controles',
          order: 4,
          description: 'Aprende la jerarqu√≠a de controles y c√≥mo aplicarlos',
          activities: [
            {
              id: 'activity_004',
              type: 'explanation',
              complexity: 'moderate',
              teaching: {
                agent_instruction: 'Explica la Jerarqu√≠a de Controles mostrada en la pir√°mide invertida de la imagen. Los 5 niveles ordenados por efectividad son: 1) ELIMINACI√ìN (m√°s efectivo - eliminar completamente el peligro), 2) SUSTITUCI√ìN (reemplazar por algo menos peligroso), 3) CONTROLES DE INGENIER√çA (guardas, ventilaci√≥n, automatizaci√≥n), 4) CONTROLES ADMINISTRATIVOS (procedimientos, capacitaci√≥n, se√±alizaci√≥n), 5) EPP (menos efectivo - √∫ltimo recurso porque el peligro sigue existiendo). Enfatiza que siempre se debe buscar controles de los niveles superiores primero. El EPP solo protege al trabajador, no elimina el peligro. Luego presenta casos para que el estudiante proponga controles.',
                target_length: '300-400 palabras',
                context: 'Normativa: Ley 29783, ISO 45001. Pa√≠s: Per√∫',
                suggested_image_ids: ['iperc-jerarquia-controles']
              },
              verification: {
                question: 'Consulta la [VER IMAGEN: Jerarqu√≠a de Controles - Pir√°mide de Efectividad] y prop√≥n controles para estos 3 peligros:\n\nPELIGRO 1: "Ruido de 95 dB en √°rea de producci√≥n por m√°quinas antiguas"\n\nPELIGRO 2: "Trabajadores manipulan solvente t√≥xico (tolueno) para limpieza de piezas"\n\nPELIGRO 3: "Operarios trabajan con esmeril angular sin guarda de protecci√≥n"\n\nPara cada peligro:\n1. Prop√≥n UN control de cada nivel de la jerarqu√≠a que sea aplicable (Eliminaci√≥n, Sustituci√≥n, Ingenier√≠a, Administrativo, EPP)\n2. Indica cu√°l control es el M√ÅS EFECTIVO seg√∫n la jerarqu√≠a\n3. Explica POR QU√â ese control es el m√°s efectivo\n4. Si tuvieras presupuesto limitado y solo pudieras aplicar UN control, ¬øcu√°l elegir√≠as y por qu√©?\n\nFormato:\n"Peligro 1:\n- Eliminaci√≥n: [propuesta o N/A]\n- Sustituci√≥n: [propuesta]\n- Ingenier√≠a: [propuesta]\n- Administrativo: [propuesta]\n- EPP: [propuesta]\nM√°s efectivo: [X] porque [raz√≥n]\nCon presupuesto limitado: [X] porque [raz√≥n pr√°ctica]"'
              },
              metadata: {
                estimated_minutes: 12,
                difficulty: 'medium',
                max_reprompts: 3
              }
            }
          ]
        },
        {
          id: 'moment_005',
          title: 'Integraci√≥n: Matriz IPERC Completa',
          order: 5,
          description: 'Aplica todo lo aprendido en un caso integrador real',
          activities: [
            {
              id: 'activity_005',
              type: 'exercise',
              complexity: 'complex',
              teaching: {
                agent_instruction: 'Presenta el caso integrador final: el estudiante debe realizar una matriz IPERC completa de un √°rea de trabajo real. Recuerda brevemente los 4 pasos: 1) Identificar peligros (usando los 7 tipos), 2) Evaluar riesgos (usando matriz 5√ó5), 3) Proponer controles (siguiendo jerarqu√≠a), 4) Documentar todo. Presenta un escenario complejo con m√∫ltiples peligros simult√°neos para que demuestre dominio completo de la metodolog√≠a IPERC.',
                target_length: '250-350 palabras',
                context: 'Caso real: √Årea de trabajo el√©ctrico en altura. Normativa: Ley 29783. Pa√≠s: Per√∫',
                suggested_image_ids: ['iperc-caso-trabajo-electrico-altura']
              },
              verification: {
                question: 'CASO INTEGRADOR FINAL - Matriz IPERC Completa\n\nObserva la [VER IMAGEN: Caso Pr√°ctico: Trabajo El√©ctrico en Altura]\n\nEres el supervisor de SSO de una empresa el√©ctrica. Analiza este escenario:\n\n√ÅREA: Mantenimiento de l√≠neas de transmisi√≥n en postes\nFECHA: 15/01/2025\nACTIVIDAD: Dos trabajadores realizan mantenimiento en poste de 12 metros de altura con l√≠neas energizadas de media tensi√≥n (22.9 kV)\n\nCONDICIONES OBSERVADAS EN LA IMAGEN:\n‚Ä¢ Trabajadores a 12m de altura\n‚Ä¢ L√≠neas el√©ctricas energizadas cercanas\n‚Ä¢ Uso de arn√©s y l√≠nea de vida\n‚Ä¢ Condiciones clim√°ticas: soleado, sin viento\n‚Ä¢ Herramientas diel√©ctricas visibles\n\nELABORA UNA MATRIZ IPERC SIMPLIFICADA:\n\n1. IDENTIFICACI√ìN (m√≠nimo 4 peligros):\n   - Identifica los peligros presentes\n   - Clasifica cada uno por tipo (Mec√°nico, F√≠sico, etc.)\n\n2. EVALUACI√ìN (usa matriz 5√ó5):\n   - Para los 2 peligros M√ÅS CR√çTICOS:\n     * Severidad (1-5)\n     * Frecuencia (A-E)\n     * Nivel de riesgo (n√∫mero y color)\n\n3. CONTROLES (jerarqu√≠a):\n   - Para cada uno de los 2 peligros m√°s cr√≠ticos:\n     * Controles existentes que observas\n     * 2 controles adicionales que propondr√≠as (indica nivel de jerarqu√≠a)\n\n4. CONCLUSI√ìN:\n   - ¬øEste trabajo es de ALTO RIESGO? ¬øPor qu√©?\n   - ¬øLos controles actuales son suficientes? ¬øQu√© falta?\n\nFormato libre pero estructurado. Demuestra dominio completo de IPERC.'
              },
              metadata: {
                estimated_minutes: 20,
                difficulty: 'hard',
                max_reprompts: 3,
                required_for_completion: true
              }
            }
          ]
        }
      ]
    }
  }

  // Cargar im√°genes desde MCP Server
  console.log('üì∏ Obteniendo im√°genes desde MCP Server...')
  const ipercImages = await getTopicImagesFromMCP('iperc')

  if (ipercImages.length > 0) {
    console.log(`‚úÖ Se cargaron ${ipercImages.length} im√°genes desde MCP`)
  } else {
    console.log('‚ö†Ô∏è  No se encontraron im√°genes en MCP (continuando sin im√°genes)')
  }

  const ipercTopic = await prisma.topic.upsert({
    where: { slug: 'iperc-basico' },
    update: {
      contentJson: ipercContent as any,
      estimatedMinutes: 69, // 10+12+15+12+20
      images: ipercImages as any,
      imagesLoadedAt: new Date()
    },
    create: {
      title: 'IPERC - Identificaci√≥n de Peligros, Evaluaci√≥n y Control de Riesgos',
      slug: 'iperc-basico',
      description: 'Aprende la metodolog√≠a IPERC seg√∫n normativa peruana',
      courseId: fundamentosCourse.id,
      instructorId: ssoInstructor.id,
      order: 1,
      estimatedMinutes: 120,
      difficulty: 'B√°sico',
      contentJson: ipercContent as any,
      images: ipercImages as any,
      imagesLoadedAt: new Date(),
      isPublished: true
    }
  })

  console.log('‚úÖ Tema IPERC creado con im√°genes')

  // 5. Crear Tema Inspecciones de Seguridad
  const inspeccionesContent: TopicContent = {
    topic: {
      id: 'topic_inspecciones_001',
      title: 'Inspecciones de Seguridad',
      learning_objective: 'El estudiante comprender√° la metodolog√≠a completa de inspecciones de seguridad, desde la planificaci√≥n hasta el seguimiento de hallazgos, aplicando la clasificaci√≥n de actos y condiciones subest√°ndares seg√∫n normativa peruana',
      expected_learning: 'Al finalizar este tema, el estudiante ser√° capaz de planificar, ejecutar y documentar inspecciones de seguridad, clasificando hallazgos por nivel de riesgo y proponiendo acciones correctivas con tiempos de levantamiento apropiados',
      key_points: [
        'Diferencia entre actos y condiciones subest√°ndares',
        'Tipos de inspecciones y frecuencias seg√∫n riesgo',
        'Registro profesional de hallazgos',
        'Clasificaci√≥n CR√çTICO/MAYOR/MENOR y tiempos de levantamiento',
        'Acciones correctivas y seguimiento hasta el cierre'
      ],
      moments: [
        // MOMENTO 1: Actos y Condiciones Subest√°ndares
        {
          id: 'moment_001',
          title: 'Actos y Condiciones Subest√°ndares',
          order: 1,
          description: 'Fundamentos: distinci√≥n entre comportamientos y estados f√≠sicos inseguros',
          activities: [
            {
              id: 'activity_001',
              type: 'explanation',
              complexity: 'simple',
              teaching: {
                agent_instruction: 'Explica de forma concisa la diferencia fundamental entre ACTO SUBEST√ÅNDAR (comportamiento inseguro del trabajador, como no usar EPP o tomar atajos) y CONDICI√ìN SUBEST√ÅNDAR (estado f√≠sico inseguro del ambiente/equipo, como piso resbaladizo o m√°quina sin guarda). Enfatiza que esta distinci√≥n es crucial porque los controles son diferentes: actos requieren capacitaci√≥n/supervisi√≥n, condiciones requieren mantenimiento/ingenier√≠a. Luego presenta 6 situaciones variadas para que el estudiante clasifique.',
                target_length: '150-250 palabras',
                context: 'Normativa: Ley 29783, DS 005-2012-TR. Pa√≠s: Per√∫',
                suggested_image_ids: ['insp-actos-condiciones']
              },
              verification: {
                question: 'Clasifica estas 6 situaciones como ACTO o CONDICI√ìN subest√°ndar. Para cada una, escribe solo "A" o "C" y explica en una l√≠nea por qu√©:\n\n1. Trabajador usando celular mientras maneja montacargas\n2. Piso con derrame de aceite no limpiado desde hace d√≠as\n3. Operario entra a espacio confinado sin permiso de trabajo\n4. Extintor con man√≥metro en zona roja (sin presi√≥n)\n5. Soldador trabajando sin careta facial\n6. Salida de emergencia bloqueada con cajas apiladas'
              },
              metadata: {
                estimated_minutes: 10,
                difficulty: 'easy',
                max_reprompts: 3
              }
            }
          ]
        },
        // MOMENTO 2: Tipos de Inspecciones
        {
          id: 'moment_002',
          title: 'Tipos de Inspecciones',
          order: 2,
          description: 'Conocer los diferentes tipos y cu√°ndo aplicar cada uno',
          activities: [
            {
              id: 'activity_002',
              type: 'explanation',
              complexity: 'simple',
              teaching: {
                agent_instruction: 'Explica brevemente los tipos de inspecciones: PLANEADAS (programadas con checklist, mensuales/semanales), INOPINADAS (sorpresa sin aviso previo para verificar cumplimiento real), y ESPEC√çFICAS (pre-uso de equipos cr√≠ticos, post-incidente). Menciona las frecuencias seg√∫n DS 005-2012-TR: diarias (supervisores), semanales (jefes), mensuales (Comit√© SST). Luego presenta 3 situaciones pr√°cticas para que el estudiante decida qu√© tipo aplicar.',
                target_length: '150-250 palabras',
                context: 'Normativa: DS 005-2012-TR, Ley 29783. Pa√≠s: Per√∫'
              },
              verification: {
                question: 'Para estas 3 situaciones, indica: a) Tipo de inspecci√≥n, b) Frecuencia, c) Qui√©n debe hacerla, d) Por qu√©:\n\nSITUACI√ìN 1: Tienes 5 montacargas que se usan diariamente en tu almac√©n.\n\nSITUACI√ìN 2: Ocurri√≥ un resbal√≥n en el √°rea de producci√≥n y necesitas investigar.\n\nSITUACI√ìN 3: Notas que cuando avisas las inspecciones con anticipaci√≥n, todo est√° "perfecto", pero normalmente hay desorden.'
              },
              metadata: {
                estimated_minutes: 10,
                difficulty: 'easy',
                max_reprompts: 3
              }
            }
          ]
        },
        // MOMENTO 3: Registro de Hallazgos
        {
          id: 'moment_003',
          title: 'Planificaci√≥n y Registro de Hallazgos',
          order: 3,
          description: 'Documentar hallazgos de forma profesional y objetiva',
          activities: [
            {
              id: 'activity_003',
              type: 'exercise',
              complexity: 'moderate',
              teaching: {
                agent_instruction: 'Ense√±a el formato est√°ndar de registro de hallazgos: Fecha, √Årea, Tipo (Acto/Condici√≥n), Descripci√≥n OBJETIVA (hechos observables, no juicios), Riesgo potencial (qu√© puede pasar). Enfatiza la importancia de ser OBJETIVO: ‚ùå"Est√° inseguro" vs ‚úÖ"Cable el√©ctrico temporal sin protecci√≥n cruza pasillo a 15cm del piso". Luego presenta un hallazgo encontrado para que el estudiante lo redacte formalmente.',
                target_length: '200-300 palabras',
                context: 'Formato seg√∫n buenas pr√°cticas de SSO en Per√∫',
                suggested_image_ids: ['insp-almacen-hallazgos']
              },
              verification: {
                question: 'Encontraste este hallazgo en un taller mec√°nico:\n\n"Un trabajador est√° usando el esmeril angular para cortar metal. No usa careta facial ni lentes de seguridad, solo tapones auditivos."\n\nRedacta el HALLAZGO #001 con este formato:\n\nHALLAZGO #001\nFecha: 15/01/2025\n√Årea: Taller Mec√°nico\nTipo: [¬øActo o Condici√≥n?]\nDescripci√≥n: [Descripci√≥n objetiva de lo observado]\nRiesgo potencial: [Qu√© puede ocurrir si no se corrige]'
              },
              metadata: {
                estimated_minutes: 12,
                difficulty: 'medium',
                max_reprompts: 3
              }
            }
          ]
        },
        // MOMENTO 4: Clasificaci√≥n de Riesgos
        {
          id: 'moment_004',
          title: 'Evaluaci√≥n del Nivel de Riesgo',
          order: 4,
          description: 'Clasificar hallazgos y asignar tiempos de levantamiento',
          activities: [
            {
              id: 'activity_004',
              type: 'exercise',
              complexity: 'moderate',
              teaching: {
                agent_instruction: 'Explica la clasificaci√≥n de hallazgos: CR√çTICO (riesgo inminente grave/fatal, parada inmediata, 0-24h), MAYOR (riesgo alto de lesi√≥n grave, acci√≥n urgente, 1-7 d√≠as), MENOR (desviaci√≥n de est√°ndar, riesgo bajo, 8-30 d√≠as). Enfatiza la pregunta clave: "¬øQu√© es lo PEOR que puede pasar?". Presenta 6 hallazgos diversos para que clasifique, asigne tiempo y justifique bas√°ndose en severidad potencial.',
                target_length: '250-350 palabras',
                context: 'Clasificaci√≥n seg√∫n buenas pr√°cticas internacionales adaptadas a Per√∫',
                suggested_image_ids: ['insp-almacen-hallazgos']
              },
              verification: {
                question: 'Clasifica estos 6 hallazgos como CR√çTICO, MAYOR o MENOR. Para cada uno indica: Clasificaci√≥n (C/M/m), Tiempo de levantamiento, y Justificaci√≥n (¬øqu√© es lo peor que puede pasar?):\n\n1. Andamio a 5m de altura: arn√©s enganchado pero l√≠nea de vida floja y mal anclada\n\n2. Tablero el√©ctrico principal con tapa abierta, conexiones energizadas expuestas, en zona de tr√°nsito frecuente\n\n3. Se√±alizaci√≥n de ruta de evacuaci√≥n en pasillo descolorida y casi ilegible\n\n4. Detector de gases vencido hace 3 meses, se sigue usando para autorizar entrada a espacios confinados\n\n5. Bidones de qu√≠micos sin etiquetas identificando contenido (operarios "saben de memoria")\n\n6. Sillas de oficina con respaldo roto o ruedas trabadas'
              },
              metadata: {
                estimated_minutes: 13,
                difficulty: 'medium',
                max_reprompts: 3
              }
            }
          ]
        },
        // MOMENTO 5: Inspecci√≥n Simulada Completa
        {
          id: 'moment_005',
          title: 'Inspecci√≥n Simulada Completa',
          order: 5,
          description: 'Aplicar todo el proceso de principio a fin',
          activities: [
            {
              id: 'activity_005',
              type: 'project',
              complexity: 'complex',
              teaching: {
                agent_instruction: 'Gu√≠a al estudiante en una inspecci√≥n simulada completa del √ÅREA DE SOLDADURA. Recu√©rdale el proceso: 1) Identificar hallazgos (actos/condiciones), 2) Registrar formalmente, 3) Clasificar por riesgo, 4) Proponer acciones correctivas usando jerarqu√≠a de controles, 5) Identificar cu√°l requiere acci√≥n INMEDIATA. Presenta el escenario con 5 hallazgos observables y pide que aplique todo lo aprendido.',
                target_length: '300-400 palabras',
                context: 'Caso pr√°ctico: √Årea de soldadura de empresa metalmec√°nica peruana',
                suggested_image_ids: ['insp-taller-soldadura-integrador']
              },
              verification: {
                question: 'CASO INTEGRADOR:\n\nEres supervisor de seguridad. Inspecciones el √ÅREA DE SOLDADURA (10:00 AM, 15/01/2025).\n\nObservas:\nA) Soldador Juan trabajando sin careta, solo con lentes oscuros comunes\nB) 2 cilindros de gas (ox√≠geno + acetileno) de pie SIN cadena de sujeci√≥n\nC) Piso: electrodos usados y cables enrollados mezclados\nD) Extintor PQS 12kg: √∫ltima inspecci√≥n mensual fue octubre 2024 (hace 3 meses)\nE) Soldador Pedro usa celular con una mano mientras sujeta pieza con la otra (no est√° soldando)\n\nTAREA:\n\n1. Identifica los 5 hallazgos (A-E): ¬øActo o Condici√≥n?\n\n2. Clasifica los 3 M√ÅS CR√çTICOS: C/M/m + tiempo de levantamiento\n\n3. Para EL M√ÅS CR√çTICO: Redacta hallazgo formal + prop√≥n acci√≥n correctiva + asigna responsable\n\n4. ¬øCu√°l requiere ACCI√ìN INMEDIATA en ese momento? ¬øPor qu√©?'
              },
              metadata: {
                estimated_minutes: 15,
                difficulty: 'hard',
                max_reprompts: 3
              }
            }
          ]
        }
      ]
    }
  }

  console.log('üì∏ Obteniendo im√°genes de inspecciones desde MCP Server...')
  const inspeccionesImages = await getTopicImagesFromMCP('inspecciones')

  if (inspeccionesImages.length > 0) {
    console.log(`‚úÖ Se cargaron ${inspeccionesImages.length} im√°genes desde MCP`)
  } else {
    console.log('‚ö†Ô∏è  No se encontraron im√°genes en MCP (se cargar√°n posteriormente)')
  }

  const inspeccionesTopic = await prisma.topic.upsert({
    where: { slug: 'inspecciones-seguridad' },
    update: {
      contentJson: inspeccionesContent as any,
      estimatedMinutes: 60, // 10+10+12+13+15
      images: inspeccionesImages as any,
      imagesLoadedAt: inspeccionesImages.length > 0 ? new Date() : null
    },
    create: {
      title: 'Inspecciones de Seguridad',
      slug: 'inspecciones-seguridad',
      description: 'Aprende a planificar, ejecutar y documentar inspecciones de seguridad, clasificando hallazgos y estableciendo acciones correctivas seg√∫n normativa peruana',
      courseId: fundamentosCourse.id,
      instructorId: ssoInstructor.id,
      order: 2,
      estimatedMinutes: 60,
      difficulty: 'Intermedio',
      contentJson: inspeccionesContent as any,
      prerequisiteTopicIds: [ipercTopic.id] as any, // Requiere completar IPERC primero
      images: inspeccionesImages as any,
      imagesLoadedAt: inspeccionesImages.length > 0 ? new Date() : null,
      isPublished: true
    }
  })

  console.log('‚úÖ Tema Inspecciones de Seguridad creado')

  // 6. Crear usuario de prueba
  const testUser = await prisma.user.upsert({
    where: { email: 'estudiante@test.com' },
    update: {},
    create: {
      email: 'estudiante@test.com',
      name: 'Estudiante de Prueba',
      googleId: null
    }
  })

  console.log('‚úÖ Usuario de prueba creado')

  console.log('\nüéâ Seed completado!')
  console.log('\nDatos creados:')
  console.log(`- Carrera: ${ssoCareer.name}`)
  console.log(`- Instructor: ${ssoInstructor.name}`)
  console.log(`- Curso: ${fundamentosCourse.title}`)
  console.log(`- Temas:`)
  console.log(`  1. ${ipercTopic.title} (${ipercTopic.estimatedMinutes} min)`)
  console.log(`  2. ${inspeccionesTopic.title} (${inspeccionesTopic.estimatedMinutes} min)`)
  console.log(`- Usuario: ${testUser.email}`)
}

main()
  .catch((e) => {
    console.error('‚ùå Error en seed:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
