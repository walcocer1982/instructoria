import { PrismaClient } from '@prisma/client'
import { TopicContent } from '../src/types/topic-content'
import { getTopicImagesFromMCP } from '../src/services/mcp-client'

const prisma = new PrismaClient()

async function main() {
  console.log('üå± Iniciando seed...')

  // 1. Crear Carrera de SSO
  const ssoCareer = await prisma.career.upsert({
    where: { slug: 'sso' },
    update: {},
    create: {
      name: 'Seguridad y Salud Ocupacional',
      slug: 'sso',
      description: 'Carrera t√©cnica en Seguridad y Salud Ocupacional seg√∫n normativa peruana',
      icon: 'ü¶∫',
      color: '#FF6B35',
      durationMonths: 12,
      level: 'T√©cnico',
      isActive: true
    }
  })

  console.log('‚úÖ Carrera SSO creada')

  // 2. Crear Instructor IA de SSO
  const ssoInstructor = await prisma.aIInstructor.upsert({
    where: { id: 'instructor_sso_001' },
    update: {},
    create: {
      id: 'instructor_sso_001',
      name: 'Prof. Claude - Instructor de SSO',
      specialty: 'Seguridad y Salud Ocupacional',
      bio: 'Instructor especializado en normativa peruana de seguridad y salud en el trabajo. Experto en IPERC, Ley 29783 y gesti√≥n de riesgos laborales.',
      avatar: 'üßë‚Äçüè´',
      modelId: 'claude-sonnet-4-5-20250929',
      systemPromptBase: 'Eres un instructor experto en Seguridad y Salud Ocupacional con conocimiento profundo de la normativa peruana.',
      temperature: 0.7,
      maxTokens: 2048,
      expertiseAreas: ['Ley 29783', 'IPERC', 'ISO 45001', 'Planes de Seguridad'],
      tone: 'Profesional, emp√°tico y motivador',
      isActive: true
    }
  })

  console.log('‚úÖ Instructor SSO creado')

  // 3. Crear Curso de Fundamentos
  const fundamentosCourse = await prisma.course.upsert({
    where: { slug: 'fundamentos-sso' },
    update: {},
    create: {
      title: 'Fundamentos de Seguridad y Salud Ocupacional',
      slug: 'fundamentos-sso',
      description: 'Curso introductorio a la SSO seg√∫n normativa peruana',
      type: 'CAREER',
      careerId: ssoCareer.id,
      order: 1,
      isPublished: true
    }
  })

  console.log('‚úÖ Curso Fundamentos creado')

  // 4. Crear Tema IPERC con contenido completo
  const ipercContent: TopicContent = {
    topic: {
      id: 'topic_iperc_001',
      title: 'IPERC - Identificaci√≥n de Peligros, Evaluaci√≥n y Control de Riesgos',
      learning_objective: 'El estudiante comprender√° y aplicar√° la metodolog√≠a IPERC para identificar peligros, evaluar riesgos y establecer controles seg√∫n la Ley 29783 de Seguridad y Salud en el Trabajo del Per√∫',
      expected_learning: 'Al finalizar este tema, el estudiante ser√° capaz de realizar una matriz IPERC b√°sica identificando peligros, evaluando riesgos y proponiendo controles jer√°rquicos',
      key_points: [
        'Identificaci√≥n de peligros en el √°rea de trabajo',
        'Evaluaci√≥n de riesgos usando matriz de probabilidad y severidad',
        'Determinaci√≥n de controles seg√∫n jerarqu√≠a',
        'Cumplimiento de la Ley 29783'
      ],
      moments: [
        {
          id: 'moment_001',
          title: 'Conceptos Fundamentales del IPERC',
          order: 1,
          description: 'Introducci√≥n a peligros y riesgos',
          activities: [
            {
              id: 'activity_001',
              type: 'explanation',
              teaching: {
                agent_instruction: 'Explica qu√© es IPERC y su importancia en la prevenci√≥n de accidentes laborales. Define la diferencia entre peligro (fuente de da√±o) y riesgo (probabilidad de que ocurra el da√±o). Usa ejemplos peruanos del sector construcci√≥n.',
                key_concepts: [
                  'Peligro: Fuente o situaci√≥n con potencial de da√±o',
                  'Riesgo: Probabilidad de que el peligro cause da√±o',
                  'IPERC: Metodolog√≠a sistem√°tica de gesti√≥n de riesgos'
                ],
                examples: [
                  'Peligro: Piso mojado ‚Üí Riesgo: Probabilidad de resbalarse',
                  'Peligro: Cable pelado ‚Üí Riesgo: Probabilidad de electrocuci√≥n',
                  'Peligro: Escalera sin barandal ‚Üí Riesgo: Probabilidad de caerse'
                ],
                image: {
                  url: 'https://example.com/images/peligro_vs_riesgo.png',
                  description: 'Infograf√≠a mostrando la diferencia entre peligro y riesgo'
                }
              },
              verification: {
                method: 'conversational',
                initial_question: 'Ahora que hemos visto la diferencia entre peligro y riesgo, ¬øpuedes explicarme con tus propias palabras cu√°l es esa diferencia? Dame un ejemplo de tu vida cotidiana o trabajo.',
                success_criteria: {
                  must_include: [
                    'Identifica que el peligro es la fuente/condici√≥n peligrosa',
                    'Entiende que el riesgo es la probabilidad/posibilidad de da√±o',
                    'Da un ejemplo coherente'
                  ],
                  understanding_level: 'applied',
                  min_completeness: 70
                },
                reprompt_strategy: {
                  if_incomplete: [
                    'Entiendo lo que dices, pero ¬øpodr√≠as explicar tambi√©n la diferencia entre ambos conceptos?',
                    'Vas por buen camino. Ahora, ¬øc√≥mo relacionas eso con la probabilidad de que ocurra un da√±o?'
                  ],
                  if_memorized_only: [
                    'Correcto, esa es la definici√≥n. Ahora, para asegurarme de que lo entendiste: imagina que ves un cable el√©ctrico sin aislamiento. ¬øQu√© ser√≠a el peligro y qu√© ser√≠a el riesgo?'
                  ],
                  if_incorrect: [
                    'Veo que hay confusi√≥n. D√©jame darte una pista: el peligro es algo que ya existe, mientras que el riesgo es algo que podr√≠a pasar. ¬øPuedes intentarlo nuevamente?'
                  ],
                  hints: [
                    'Piensa: el peligro es la CAUSA, el riesgo es la CONSECUENCIA potencial',
                    'Ejemplo: si hay un charco (peligro), ¬øqu√© podr√≠a pasar? (riesgo)',
                    'Peligro = ¬øQu√© situaci√≥n peligrosa hay? | Riesgo = ¬øQu√© probabilidad hay de da√±o?'
                  ]
                }
              },
              student_evidence: {
                type: 'conversational_assessment',
                description: 'El estudiante explica con sus palabras la diferencia entre peligro y riesgo',
                captured_data: {
                  conversation_transcript: true,
                  key_insights: true,
                  attempts_count: true,
                  understanding_level: true
                }
              },
              student_questions: {
                allowed: true,
                scope: {
                  current_activity: true,
                  current_moment: true,
                  current_topic: true,
                  related_topics: false,
                  off_topic: false
                },
                out_of_scope_strategy: {
                  acknowledge: true,
                  brief_answer: true,
                  redirect: true,
                  response_templates: {
                    related_but_future_topic: 'Excelente pregunta sobre {tema}. Ese tema lo veremos m√°s adelante. Por ahora, enfoqu√©monos en entender bien peligro vs riesgo.',
                    related_but_different_course: 'Buena pregunta. {tema} es parte de otro curso. Si te interesa, puedes inscribirte despu√©s.',
                    tangentially_related: 'Interesante punto, aunque no es parte de este tema. Te puedo dar una respuesta breve: {respuesta_corta}. Ahora, volvamos a IPERC.',
                    completely_off_topic: 'Entiendo tu curiosidad, pero esa pregunta est√° fuera del alcance de este curso de SSO. Mantengamos el foco en IPERC.'
                  }
                },
                expected_question_types: ['clarification', 'example_request', 'application', 'why_question']
              },
              guardrails: {
                prohibited_topics: ['sexual_content', 'violence', 'illegal_activities', 'personal_attacks'],
                response_on_violation: {
                  template: 'No puedo ayudarte con ese tema. Soy un instructor de {especialidad} y debo mantener conversaciones profesionales. ¬øVolvemos a {tema_actual}?',
                  log_incident: true,
                  escalate_after: 3
                },
                tone_requirements: {
                  professional: true,
                  respectful: true,
                  encouraging: true,
                  no_judgment: true
                }
              },
              metadata: {
                estimated_minutes: 10,
                difficulty: 'easy',
                max_reprompts: 3,
                allow_skip: false,
                required_for_completion: true
              }
            }
          ]
        },
        // MOMENTO 2: Identificaci√≥n de Peligros
        {
          id: 'moment_002',
          title: 'Identificaci√≥n de Peligros',
          order: 2,
          description: 'Aprende a identificar los 7 tipos de peligros en el trabajo',
          activities: [
            {
              id: 'activity_002',
              type: 'explanation',
              teaching: {
                agent_instruction: 'Ense√±a c√≥mo identificar peligros: mec√°nicos, f√≠sicos, qu√≠micos, biol√≥gicos, ergon√≥micos, psicosociales y locativos. Explica que se debe recorrer el √°rea de trabajo y observar todas las actividades.',
                key_concepts: [
                  'Mec√°nicos: M√°quinas, herramientas, veh√≠culos',
                  'F√≠sicos: Ruido, vibraci√≥n, iluminaci√≥n, temperatura',
                  'Qu√≠micos: Solventes, gases, polvos',
                  'Biol√≥gicos: Virus, bacterias, hongos',
                  'Ergon√≥micos: Posturas forzadas, movimientos repetitivos',
                  'Psicosociales: Estr√©s, hostigamiento, carga mental',
                  'Locativos: Pisos, escaleras, techos, espacios confinados'
                ],
                examples: [
                  'Taller de soldadura: proyecci√≥n de chispas (mec√°nico), humos met√°licos (qu√≠mico), ruido (f√≠sico)',
                  'Oficina: postura sentada prolongada (ergon√≥mico), carga de trabajo (psicosocial)',
                  'Almac√©n: estanter√≠as inestables (locativo), cargas pesadas (ergon√≥mico)'
                ],
                image: {
                  url: 'https://example.com/images/tipos_peligros.png',
                  description: 'Tabla con los 7 tipos de peligros y ejemplos'
                }
              },
              verification: {
                method: 'conversational',
                initial_question: 'Te voy a describir un taller de soldadura: hay m√°quinas de soldar funcionando, trabajadores cortando metal, humos en el ambiente, ruido constante y algunos cables en el piso. ¬øQu√© peligros identificas aqu√≠? N√≥mbralos y clasif√≠calos por tipo.',
                success_criteria: {
                  must_include: [
                    'Identifica al menos 3 tipos diferentes de peligros',
                    'Clasifica correctamente cada peligro',
                    'Menciona peligros reales del escenario'
                  ],
                  understanding_level: 'applied',
                  min_completeness: 70
                },
                reprompt_strategy: {
                  if_incomplete: [
                    'Bien, has identificado algunos. ¬øQu√© m√°s observas? Piensa en el ruido, los humos y el estado del piso.',
                    'Vas bien, pero faltan algunos. Te doy una pista: ¬øqu√© pasa con el aire que respiran? ¬øY el nivel de ruido?'
                  ],
                  if_memorized_only: [
                    'Correcto en la teor√≠a. Ahora apl√≠calo: en el taller que te describ√≠, ¬øcu√°les espec√≠ficamente ser√≠an los peligros mec√°nicos y qu√≠micos?'
                  ],
                  if_incorrect: [
                    'Revisa la clasificaci√≥n. Por ejemplo, los humos met√°licos son peligros qu√≠micos, no f√≠sicos. ¬øPuedes intentarlo de nuevo?'
                  ],
                  hints: [
                    'Recuerda: m√°quinas y herramientas = mec√°nico, sustancias en el aire = qu√≠mico, sonido = f√≠sico',
                    'Los cables en el piso tambi√©n son un peligro. ¬øDe qu√© tipo?',
                    'Piensa en qu√© puede da√±ar al trabajador: las m√°quinas, los gases, el ruido...'
                  ]
                }
              },
              student_evidence: {
                type: 'conversational_assessment',
                description: 'El estudiante identifica y clasifica peligros en un escenario laboral',
                captured_data: {
                  conversation_transcript: true,
                  key_insights: true,
                  attempts_count: true,
                  understanding_level: true
                }
              },
              student_questions: {
                allowed: true,
                scope: {
                  current_activity: true,
                  current_moment: true,
                  current_topic: true,
                  related_topics: false,
                  off_topic: false
                },
                out_of_scope_strategy: {
                  acknowledge: true,
                  brief_answer: true,
                  redirect: true,
                  response_templates: {
                    related_but_future_topic: 'Buena pregunta. Ese tema lo veremos m√°s adelante.',
                    related_but_different_course: 'Esa pregunta corresponde a otro curso.',
                    tangentially_related: 'Interesante, pero enfoqu√©monos en identificar peligros primero.',
                    completely_off_topic: 'Esa pregunta est√° fuera del tema. Volvamos a IPERC.'
                  }
                },
                expected_question_types: ['clarification', 'example_request', 'application']
              },
              guardrails: {
                prohibited_topics: ['sexual_content', 'violence', 'illegal_activities', 'personal_attacks'],
                response_on_violation: {
                  template: 'No puedo ayudarte con ese tema. Mantengamos una conversaci√≥n profesional sobre SSO.',
                  log_incident: true,
                  escalate_after: 3
                },
                tone_requirements: {
                  professional: true,
                  respectful: true,
                  encouraging: true,
                  no_judgment: true
                }
              },
              metadata: {
                estimated_minutes: 12,
                difficulty: 'medium',
                max_reprompts: 3,
                allow_skip: false,
                required_for_completion: true
              }
            }
          ]
        },
        // MOMENTO 3: Evaluaci√≥n de Riesgos
        {
          id: 'moment_003',
          title: 'Evaluaci√≥n de Riesgos',
          order: 3,
          description: 'Aprende a evaluar riesgos usando la matriz de probabilidad y severidad',
          activities: [
            {
              id: 'activity_003',
              type: 'explanation',
              teaching: {
                agent_instruction: 'Explica la matriz de evaluaci√≥n de riesgos: Probabilidad (Baja=1, Media=2, Alta=3) x Severidad (Ligeramente da√±ino=1, Da√±ino=2, Extremadamente da√±ino=3). Resultado: Trivial (1-2), Tolerable (3-4), Moderado (5-6), Importante (8-9), Intolerable (12+).',
                key_concepts: [
                  'Probabilidad: ¬øQu√© tan probable es que ocurra? (Baja, Media, Alta)',
                  'Severidad: Si ocurre, ¬øqu√© tan grave ser√≠a? (Leve, Da√±ino, Extremo)',
                  'Nivel de Riesgo = Probabilidad √ó Severidad',
                  'Acci√≥n seg√∫n nivel: Trivial (seguimiento), Tolerable (verificar), Moderado (reducir), Importante (corregir pronto), Intolerable (detener trabajo)'
                ],
                examples: [
                  'Piso mojado: Probabilidad Alta (3) √ó Severidad Da√±ina (2) = 6 (Moderado)',
                  'Trabajo en altura sin arn√©s: Probabilidad Media (2) √ó Severidad Extrema (3) = 6 pero cr√≠tico',
                  'Cable pelado en zona de tr√°nsito: Probabilidad Alta (3) √ó Severidad Extrema (3) = 9 (Importante)'
                ],
                image: {
                  url: 'https://example.com/images/matriz_riesgo.png',
                  description: 'Matriz 5x5 de evaluaci√≥n de riesgos (severidad vs probabilidad)'
                }
              },
              verification: {
                method: 'conversational',
                initial_question: 'Ahora vamos a practicar. Si tenemos un peligro de "proyecci√≥n de chispas durante soldadura" y sabemos que ocurre frecuentemente en el taller (probabilidad Alta=3) y puede causar quemaduras en piel (severidad Da√±ina=2), ¬øcu√°l ser√≠a el nivel de riesgo? Mu√©strame el c√°lculo.',
                success_criteria: {
                  must_include: [
                    'Realiza el c√°lculo correcto: 3 √ó 2 = 6',
                    'Identifica el nivel de riesgo: Moderado',
                    'Demuestra comprensi√≥n de la f√≥rmula'
                  ],
                  understanding_level: 'applied',
                  min_completeness: 80
                },
                reprompt_strategy: {
                  if_incomplete: [
                    'Bien el c√°lculo. Ahora, con ese resultado de 6, ¬øen qu√© categor√≠a de riesgo lo clasificar√≠as?',
                    'Correcto. Y seg√∫n esa clasificaci√≥n, ¬øqu√© acci√≥n deber√≠amos tomar?'
                  ],
                  if_memorized_only: [
                    'La f√≥rmula est√° correcta. Ahora apl√≠cala: ¬øcu√°nto es 3 por 2?'
                  ],
                  if_incorrect: [
                    'Revisa la operaci√≥n. Recuerda: Probabilidad √ó Severidad. Si es Alta (3) y Da√±ina (2), ¬øcu√°nto da?',
                    'Ese resultado no es correcto. La probabilidad Alta es 3, la severidad Da√±ina es 2. ¬øQu√© operaci√≥n hacemos con esos n√∫meros?'
                  ],
                  hints: [
                    'Recuerda: es una multiplicaci√≥n, no una suma',
                    'Alta = 3, Da√±ina = 2. Entonces: 3 √ó 2 = ?',
                    'Los niveles son: 1-2 Trivial, 3-4 Tolerable, 5-6 Moderado, 8-9 Importante, 12 Intolerable'
                  ]
                }
              },
              student_evidence: {
                type: 'conversational_assessment',
                description: 'El estudiante calcula correctamente el nivel de riesgo',
                captured_data: {
                  conversation_transcript: true,
                  key_insights: true,
                  attempts_count: true,
                  understanding_level: true
                }
              },
              student_questions: {
                allowed: true,
                scope: {
                  current_activity: true,
                  current_moment: true,
                  current_topic: true,
                  related_topics: false,
                  off_topic: false
                },
                out_of_scope_strategy: {
                  acknowledge: true,
                  brief_answer: true,
                  redirect: true,
                  response_templates: {
                    related_but_future_topic: 'Esa pregunta la veremos m√°s adelante.',
                    related_but_different_course: 'Eso corresponde a otro curso.',
                    tangentially_related: 'Interesante, pero enfoqu√©monos en la evaluaci√≥n de riesgos.',
                    completely_off_topic: 'Mantengamos el foco en IPERC.'
                  }
                },
                expected_question_types: ['clarification', 'example_request', 'application']
              },
              guardrails: {
                prohibited_topics: ['sexual_content', 'violence', 'illegal_activities', 'personal_attacks'],
                response_on_violation: {
                  template: 'Mantengamos una conversaci√≥n profesional sobre SSO.',
                  log_incident: true,
                  escalate_after: 3
                },
                tone_requirements: {
                  professional: true,
                  respectful: true,
                  encouraging: true,
                  no_judgment: true
                }
              },
              metadata: {
                estimated_minutes: 15,
                difficulty: 'medium',
                max_reprompts: 3,
                allow_skip: false,
                required_for_completion: true
              }
            }
          ]
        },
        // MOMENTO 4: Determinaci√≥n de Controles
        {
          id: 'moment_004',
          title: 'Determinaci√≥n de Controles',
          order: 4,
          description: 'Aprende la jerarqu√≠a de controles seg√∫n normativa peruana',
          activities: [
            {
              id: 'activity_004',
              type: 'explanation',
              teaching: {
                agent_instruction: 'Explica la jerarqu√≠a de controles: 1¬∞ Eliminaci√≥n, 2¬∞ Sustituci√≥n, 3¬∞ Controles de ingenier√≠a, 4¬∞ Controles administrativos (se√±alizaci√≥n, capacitaci√≥n, procedimientos), 5¬∞ EPP (√∫ltima opci√≥n). Enfatiza que el EPP solo protege al trabajador pero no elimina el peligro.',
                key_concepts: [
                  '1. Eliminaci√≥n: Remover completamente el peligro',
                  '2. Sustituci√≥n: Reemplazar por algo menos peligroso',
                  '3. Controles de ingenier√≠a: Barreras, ventilaci√≥n, guardas',
                  '4. Controles administrativos: Procedimientos, capacitaci√≥n, se√±alizaci√≥n',
                  '5. EPP: Equipos de protecci√≥n personal (√∫ltima l√≠nea de defensa)'
                ],
                examples: [
                  'Eliminaci√≥n: Automatizar soldadura para que no haya operador expuesto',
                  'Sustituci√≥n: Usar pintura al agua en vez de pintura con solventes',
                  'Ingenier√≠a: Instalar extractores de humo en zona de soldadura',
                  'Administrativos: Crear procedimiento de trabajo seguro para soldadura',
                  'EPP: Careta de soldar, guantes de cuero, mandil'
                ],
                image: {
                  url: 'https://example.com/images/jerarquia_controles.png',
                  description: 'Pir√°mide invertida de jerarqu√≠a de controles'
                }
              },
              verification: {
                method: 'conversational',
                initial_question: 'Perfecto. Ahora dime: ¬øpor qu√© crees que el EPP (como casco, guantes, lentes) es la √∫ltima opci√≥n en la jerarqu√≠a y no la primera? Explica con tus palabras.',
                success_criteria: {
                  must_include: [
                    'Menciona que el EPP solo protege al trabajador',
                    'Entiende que el peligro sigue existiendo con EPP',
                    'Explica que eliminar/sustituir es m√°s efectivo'
                  ],
                  understanding_level: 'understood',
                  min_completeness: 70
                },
                reprompt_strategy: {
                  if_incomplete: [
                    'Vas bien. Ahora piensa: si un trabajador usa casco, ¬øel riesgo de ca√≠da de objetos desaparece o solo se reduce el da√±o?',
                    'Correcto. Entonces, ¬øqu√© ser√≠a mejor: eliminar el riesgo de ca√≠da o darle casco al trabajador?'
                  ],
                  if_memorized_only: [
                    'Exacto, esa es la teor√≠a. Dame un ejemplo pr√°ctico: si hay un cable pelado, ¬øes mejor darle guantes al trabajador o reparar el cable?'
                  ],
                  if_incorrect: [
                    'Pi√©nsalo as√≠: el EPP protege a la persona, pero el peligro sigue ah√≠. Si eliminamos el peligro, ya no hace falta el EPP. ¬øAhora tiene m√°s sentido?'
                  ],
                  hints: [
                    'Pista: El EPP es como un paraguas. Te protege de la lluvia, pero la lluvia sigue cayendo',
                    'Los controles superiores atacan la causa; el EPP solo reduce la consecuencia',
                    'Si puedes eliminar el peligro, ¬øpara qu√© necesitas EPP?'
                  ]
                }
              },
              student_evidence: {
                type: 'conversational_assessment',
                description: 'El estudiante explica la jerarqu√≠a de controles',
                captured_data: {
                  conversation_transcript: true,
                  key_insights: true,
                  attempts_count: true,
                  understanding_level: true
                }
              },
              student_questions: {
                allowed: true,
                scope: {
                  current_activity: true,
                  current_moment: true,
                  current_topic: true,
                  related_topics: false,
                  off_topic: false
                },
                out_of_scope_strategy: {
                  acknowledge: true,
                  brief_answer: true,
                  redirect: true,
                  response_templates: {
                    related_but_future_topic: 'Eso lo veremos despu√©s.',
                    related_but_different_course: 'Eso es otro tema.',
                    tangentially_related: 'Interesante, pero enfoqu√©monos en la jerarqu√≠a de controles.',
                    completely_off_topic: 'Volvamos al tema de controles.'
                  }
                },
                expected_question_types: ['clarification', 'example_request', 'why_question']
              },
              guardrails: {
                prohibited_topics: ['sexual_content', 'violence', 'illegal_activities', 'personal_attacks'],
                response_on_violation: {
                  template: 'Mantengamos una conversaci√≥n profesional.',
                  log_incident: true,
                  escalate_after: 3
                },
                tone_requirements: {
                  professional: true,
                  respectful: true,
                  encouraging: true,
                  no_judgment: true
                }
              },
              metadata: {
                estimated_minutes: 12,
                difficulty: 'medium',
                max_reprompts: 3,
                allow_skip: false,
                required_for_completion: true
              }
            }
          ]
        },
        // MOMENTO 5: Evaluaci√≥n Final - Aplicaci√≥n Completa
        {
          id: 'moment_005',
          title: 'Evaluaci√≥n Final - Aplicaci√≥n Completa de IPERC',
          order: 5,
          description: 'Demuestra tu comprensi√≥n aplicando todo lo aprendido',
          activities: [
            {
              id: 'activity_005',
              type: 'project',
              teaching: {
                agent_instruction: 'Gu√≠a al estudiante para que aplique toda la metodolog√≠a IPERC: 1) Elegir un √°rea de trabajo (su casa, oficina, taller), 2) Identificar m√≠nimo 2 peligros, 3) Evaluar cada riesgo con la matriz, 4) Proponer controles usando la jerarqu√≠a.',
                key_concepts: [
                  'Aplicaci√≥n completa de IPERC',
                  'Identificaci√≥n de peligros reales',
                  'Evaluaci√≥n cuantitativa de riesgos',
                  'Propuesta de controles jer√°rquicos'
                ],
                examples: [
                  'Ejemplo completo: Peligro=escalera sin barandal ‚Üí Riesgo=ca√≠da ‚Üí P(3)√óS(3)=9 (Importante) ‚Üí Control: instalar barandal (ingenier√≠a)',
                  'Otro: Peligro=monitor muy cerca ‚Üí Riesgo=fatiga visual ‚Üí P(2)√óS(1)=2 (Trivial) ‚Üí Control: ajustar distancia (administrativo)'
                ],
                image: {
                  url: 'https://example.com/images/plantilla_iperc.png',
                  description: 'Plantilla de matriz IPERC'
                }
              },
              verification: {
                method: 'conversational',
                initial_question: 'Para tu evaluaci√≥n final, elige un lugar que conozcas (tu casa, trabajo, o un lugar p√∫blico). Identifica 2 peligros, eval√∫a sus riesgos y prop√≥n controles. Usa este formato:\n\nPeligro 1: [describe]\nRiesgo: [qu√© da√±o podr√≠a ocurrir]\nProbabilidad: [Baja/Media/Alta]\nSeveridad: [Leve/Da√±ino/Extremo]\nNivel de Riesgo: [c√°lculo]\nControles propuestos: [lista]',
                success_criteria: {
                  must_include: [
                    'Identifica 2 peligros reales y espec√≠ficos',
                    'Eval√∫a correctamente probabilidad y severidad',
                    'Calcula nivel de riesgo correctamente',
                    'Propone controles que siguen la jerarqu√≠a'
                  ],
                  understanding_level: 'analyzed',
                  min_completeness: 80
                },
                reprompt_strategy: {
                  if_incomplete: [
                    'Bien, pero falta completar algunos campos. ¬øPodr√≠as agregar la evaluaci√≥n de probabilidad y severidad?',
                    'Vas bien, pero necesito que propongas controles espec√≠ficos para cada peligro.'
                  ],
                  if_memorized_only: [
                    'Veo que conoces la teor√≠a. Ahora s√© m√°s espec√≠fico: en lugar de decir "usar EPP", dime qu√© EPP exactamente.'
                  ],
                  if_incorrect: [
                    'Revisa tu c√°lculo de riesgo. Recuerda que es Probabilidad √ó Severidad.',
                    'Ese control no sigue la jerarqu√≠a. ¬øHay algo que puedas hacer antes de llegar al EPP?'
                  ],
                  hints: [
                    'Piensa en tu entorno diario: cables, escaleras, ventanas, productos de limpieza...',
                    'Recuerda usar la escala: 1, 2 o 3 para probabilidad y severidad',
                    'Los controles deben ser realistas y aplicables'
                  ]
                }
              },
              student_evidence: {
                type: 'conversational_assessment',
                description: 'Matriz IPERC completa con 2 peligros evaluados',
                captured_data: {
                  conversation_transcript: true,
                  key_insights: true,
                  attempts_count: true,
                  understanding_level: true
                }
              },
              student_questions: {
                allowed: true,
                scope: {
                  current_activity: true,
                  current_moment: true,
                  current_topic: true,
                  related_topics: true,
                  off_topic: false
                },
                out_of_scope_strategy: {
                  acknowledge: true,
                  brief_answer: true,
                  redirect: true,
                  response_templates: {
                    related_but_future_topic: 'Buena pregunta, pero enfoqu√©monos en completar tu IPERC.',
                    related_but_different_course: 'Eso es otro curso.',
                    tangentially_related: 'Interesante, pero terminemos tu evaluaci√≥n primero.',
                    completely_off_topic: 'Mantengamos el foco en tu proyecto IPERC.'
                  }
                },
                expected_question_types: ['clarification', 'example_request', 'application']
              },
              guardrails: {
                prohibited_topics: ['sexual_content', 'violence', 'illegal_activities', 'personal_attacks'],
                response_on_violation: {
                  template: 'Mantengamos una conversaci√≥n profesional.',
                  log_incident: true,
                  escalate_after: 3
                },
                tone_requirements: {
                  professional: true,
                  respectful: true,
                  encouraging: true,
                  no_judgment: true
                }
              },
              metadata: {
                estimated_minutes: 20,
                difficulty: 'hard',
                max_reprompts: 5,
                allow_skip: false,
                required_for_completion: true
              }
            }
          ]
        }
      ]
    }
  }

  // Cargar im√°genes desde MCP Server
  console.log('üì∏ Obteniendo im√°genes desde MCP Server...')
  const ipercImages = await getTopicImagesFromMCP('iperc')

  if (ipercImages.length > 0) {
    console.log(`‚úÖ Se cargaron ${ipercImages.length} im√°genes desde MCP`)
  } else {
    console.log('‚ö†Ô∏è  No se encontraron im√°genes en MCP (continuando sin im√°genes)')
  }

  const ipercTopic = await prisma.topic.upsert({
    where: { slug: 'iperc-basico' },
    update: {
      contentJson: ipercContent as any,
      estimatedMinutes: 69, // 10+12+15+12+20
      images: ipercImages as any,
      imagesLoadedAt: new Date()
    },
    create: {
      title: 'IPERC - Identificaci√≥n de Peligros, Evaluaci√≥n y Control de Riesgos',
      slug: 'iperc-basico',
      description: 'Aprende la metodolog√≠a IPERC seg√∫n normativa peruana',
      courseId: fundamentosCourse.id,
      instructorId: ssoInstructor.id,
      order: 1,
      estimatedMinutes: 120,
      difficulty: 'B√°sico',
      contentJson: ipercContent as any,
      images: ipercImages as any,
      imagesLoadedAt: new Date(),
      isPublished: true
    }
  })

  console.log('‚úÖ Tema IPERC creado con im√°genes')

  // 5. Crear Tema Inspecciones de Seguridad
  const inspeccionesContent: TopicContent = {
    topic: {
      id: 'topic_inspecciones_001',
      title: 'Inspecciones de Seguridad',
      learning_objective: 'El estudiante comprender√° la metodolog√≠a completa de inspecciones de seguridad, desde la planificaci√≥n hasta el seguimiento de hallazgos, aplicando la clasificaci√≥n de actos y condiciones subest√°ndares seg√∫n normativa peruana',
      expected_learning: 'Al finalizar este tema, el estudiante ser√° capaz de planificar, ejecutar y documentar inspecciones de seguridad, clasificando hallazgos por nivel de riesgo y proponiendo acciones correctivas con tiempos de levantamiento apropiados',
      key_points: [
        'Diferencia entre actos y condiciones subest√°ndares',
        'Tipos de inspecciones y frecuencias seg√∫n riesgo',
        'Registro profesional de hallazgos',
        'Clasificaci√≥n CR√çTICO/MAYOR/MENOR y tiempos de levantamiento',
        'Acciones correctivas y seguimiento hasta el cierre'
      ],
      moments: [
        // MOMENTO 1: Actos y Condiciones Subest√°ndares
        {
          id: 'moment_001',
          title: 'Actos y Condiciones Subest√°ndares',
          order: 1,
          description: 'Fundamentos: distinci√≥n entre comportamientos y estados f√≠sicos inseguros',
          activities: [
            {
              id: 'activity_001',
              type: 'explanation',
              complexity: 'simple',
              teaching: {
                agent_instruction: 'Explica de forma concisa la diferencia fundamental entre ACTO SUBEST√ÅNDAR (comportamiento inseguro del trabajador, como no usar EPP o tomar atajos) y CONDICI√ìN SUBEST√ÅNDAR (estado f√≠sico inseguro del ambiente/equipo, como piso resbaladizo o m√°quina sin guarda). Enfatiza que esta distinci√≥n es crucial porque los controles son diferentes: actos requieren capacitaci√≥n/supervisi√≥n, condiciones requieren mantenimiento/ingenier√≠a. Luego presenta 6 situaciones variadas para que el estudiante clasifique.',
                target_length: '150-250 palabras',
                context: 'Normativa: Ley 29783, DS 005-2012-TR. Pa√≠s: Per√∫',
                suggested_image_ids: ['insp-actos-condiciones']
              },
              verification: {
                question: 'Clasifica estas 6 situaciones como ACTO o CONDICI√ìN subest√°ndar. Para cada una, escribe solo "A" o "C" y explica en una l√≠nea por qu√©:\n\n1. Trabajador usando celular mientras maneja montacargas\n2. Piso con derrame de aceite no limpiado desde hace d√≠as\n3. Operario entra a espacio confinado sin permiso de trabajo\n4. Extintor con man√≥metro en zona roja (sin presi√≥n)\n5. Soldador trabajando sin careta facial\n6. Salida de emergencia bloqueada con cajas apiladas'
              },
              metadata: {
                estimated_minutes: 10,
                difficulty: 'easy',
                max_reprompts: 3
              }
            }
          ]
        },
        // MOMENTO 2: Tipos de Inspecciones
        {
          id: 'moment_002',
          title: 'Tipos de Inspecciones',
          order: 2,
          description: 'Conocer los diferentes tipos y cu√°ndo aplicar cada uno',
          activities: [
            {
              id: 'activity_002',
              type: 'explanation',
              complexity: 'simple',
              teaching: {
                agent_instruction: 'Explica brevemente los tipos de inspecciones: PLANEADAS (programadas con checklist, mensuales/semanales), INOPINADAS (sorpresa sin aviso previo para verificar cumplimiento real), y ESPEC√çFICAS (pre-uso de equipos cr√≠ticos, post-incidente). Menciona las frecuencias seg√∫n DS 005-2012-TR: diarias (supervisores), semanales (jefes), mensuales (Comit√© SST). Luego presenta 3 situaciones pr√°cticas para que el estudiante decida qu√© tipo aplicar.',
                target_length: '150-250 palabras',
                context: 'Normativa: DS 005-2012-TR, Ley 29783. Pa√≠s: Per√∫'
              },
              verification: {
                question: 'Para estas 3 situaciones, indica: a) Tipo de inspecci√≥n, b) Frecuencia, c) Qui√©n debe hacerla, d) Por qu√©:\n\nSITUACI√ìN 1: Tienes 5 montacargas que se usan diariamente en tu almac√©n.\n\nSITUACI√ìN 2: Ocurri√≥ un resbal√≥n en el √°rea de producci√≥n y necesitas investigar.\n\nSITUACI√ìN 3: Notas que cuando avisas las inspecciones con anticipaci√≥n, todo est√° "perfecto", pero normalmente hay desorden.'
              },
              metadata: {
                estimated_minutes: 10,
                difficulty: 'easy',
                max_reprompts: 3
              }
            }
          ]
        },
        // MOMENTO 3: Registro de Hallazgos
        {
          id: 'moment_003',
          title: 'Planificaci√≥n y Registro de Hallazgos',
          order: 3,
          description: 'Documentar hallazgos de forma profesional y objetiva',
          activities: [
            {
              id: 'activity_003',
              type: 'exercise',
              complexity: 'moderate',
              teaching: {
                agent_instruction: 'Ense√±a el formato est√°ndar de registro de hallazgos: Fecha, √Årea, Tipo (Acto/Condici√≥n), Descripci√≥n OBJETIVA (hechos observables, no juicios), Riesgo potencial (qu√© puede pasar). Enfatiza la importancia de ser OBJETIVO: ‚ùå"Est√° inseguro" vs ‚úÖ"Cable el√©ctrico temporal sin protecci√≥n cruza pasillo a 15cm del piso". Luego presenta un hallazgo encontrado para que el estudiante lo redacte formalmente.',
                target_length: '200-300 palabras',
                context: 'Formato seg√∫n buenas pr√°cticas de SSO en Per√∫',
                suggested_image_ids: ['insp-almacen-hallazgos']
              },
              verification: {
                question: 'Encontraste este hallazgo en un taller mec√°nico:\n\n"Un trabajador est√° usando el esmeril angular para cortar metal. No usa careta facial ni lentes de seguridad, solo tapones auditivos."\n\nRedacta el HALLAZGO #001 con este formato:\n\nHALLAZGO #001\nFecha: 15/01/2025\n√Årea: Taller Mec√°nico\nTipo: [¬øActo o Condici√≥n?]\nDescripci√≥n: [Descripci√≥n objetiva de lo observado]\nRiesgo potencial: [Qu√© puede ocurrir si no se corrige]'
              },
              metadata: {
                estimated_minutes: 12,
                difficulty: 'medium',
                max_reprompts: 3
              }
            }
          ]
        },
        // MOMENTO 4: Clasificaci√≥n de Riesgos
        {
          id: 'moment_004',
          title: 'Evaluaci√≥n del Nivel de Riesgo',
          order: 4,
          description: 'Clasificar hallazgos y asignar tiempos de levantamiento',
          activities: [
            {
              id: 'activity_004',
              type: 'exercise',
              complexity: 'moderate',
              teaching: {
                agent_instruction: 'Explica la clasificaci√≥n de hallazgos: CR√çTICO (riesgo inminente grave/fatal, parada inmediata, 0-24h), MAYOR (riesgo alto de lesi√≥n grave, acci√≥n urgente, 1-7 d√≠as), MENOR (desviaci√≥n de est√°ndar, riesgo bajo, 8-30 d√≠as). Enfatiza la pregunta clave: "¬øQu√© es lo PEOR que puede pasar?". Presenta 6 hallazgos diversos para que clasifique, asigne tiempo y justifique bas√°ndose en severidad potencial.',
                target_length: '250-350 palabras',
                context: 'Clasificaci√≥n seg√∫n buenas pr√°cticas internacionales adaptadas a Per√∫',
                suggested_image_ids: ['insp-almacen-hallazgos']
              },
              verification: {
                question: 'Clasifica estos 6 hallazgos como CR√çTICO, MAYOR o MENOR. Para cada uno indica: Clasificaci√≥n (C/M/m), Tiempo de levantamiento, y Justificaci√≥n (¬øqu√© es lo peor que puede pasar?):\n\n1. Andamio a 5m de altura: arn√©s enganchado pero l√≠nea de vida floja y mal anclada\n\n2. Tablero el√©ctrico principal con tapa abierta, conexiones energizadas expuestas, en zona de tr√°nsito frecuente\n\n3. Se√±alizaci√≥n de ruta de evacuaci√≥n en pasillo descolorida y casi ilegible\n\n4. Detector de gases vencido hace 3 meses, se sigue usando para autorizar entrada a espacios confinados\n\n5. Bidones de qu√≠micos sin etiquetas identificando contenido (operarios "saben de memoria")\n\n6. Sillas de oficina con respaldo roto o ruedas trabadas'
              },
              metadata: {
                estimated_minutes: 13,
                difficulty: 'medium',
                max_reprompts: 3
              }
            }
          ]
        },
        // MOMENTO 5: Inspecci√≥n Simulada Completa
        {
          id: 'moment_005',
          title: 'Inspecci√≥n Simulada Completa',
          order: 5,
          description: 'Aplicar todo el proceso de principio a fin',
          activities: [
            {
              id: 'activity_005',
              type: 'project',
              complexity: 'complex',
              teaching: {
                agent_instruction: 'Gu√≠a al estudiante en una inspecci√≥n simulada completa del √ÅREA DE SOLDADURA. Recu√©rdale el proceso: 1) Identificar hallazgos (actos/condiciones), 2) Registrar formalmente, 3) Clasificar por riesgo, 4) Proponer acciones correctivas usando jerarqu√≠a de controles, 5) Identificar cu√°l requiere acci√≥n INMEDIATA. Presenta el escenario con 5 hallazgos observables y pide que aplique todo lo aprendido.',
                target_length: '300-400 palabras',
                context: 'Caso pr√°ctico: √Årea de soldadura de empresa metalmec√°nica peruana',
                suggested_image_ids: ['insp-taller-soldadura-integrador']
              },
              verification: {
                question: 'CASO INTEGRADOR:\n\nEres supervisor de seguridad. Inspecciones el √ÅREA DE SOLDADURA (10:00 AM, 15/01/2025).\n\nObservas:\nA) Soldador Juan trabajando sin careta, solo con lentes oscuros comunes\nB) 2 cilindros de gas (ox√≠geno + acetileno) de pie SIN cadena de sujeci√≥n\nC) Piso: electrodos usados y cables enrollados mezclados\nD) Extintor PQS 12kg: √∫ltima inspecci√≥n mensual fue octubre 2024 (hace 3 meses)\nE) Soldador Pedro usa celular con una mano mientras sujeta pieza con la otra (no est√° soldando)\n\nTAREA:\n\n1. Identifica los 5 hallazgos (A-E): ¬øActo o Condici√≥n?\n\n2. Clasifica los 3 M√ÅS CR√çTICOS: C/M/m + tiempo de levantamiento\n\n3. Para EL M√ÅS CR√çTICO: Redacta hallazgo formal + prop√≥n acci√≥n correctiva + asigna responsable\n\n4. ¬øCu√°l requiere ACCI√ìN INMEDIATA en ese momento? ¬øPor qu√©?'
              },
              metadata: {
                estimated_minutes: 15,
                difficulty: 'hard',
                max_reprompts: 3
              }
            }
          ]
        }
      ]
    }
  }

  console.log('üì∏ Obteniendo im√°genes de inspecciones desde MCP Server...')
  const inspeccionesImages = await getTopicImagesFromMCP('inspecciones')

  if (inspeccionesImages.length > 0) {
    console.log(`‚úÖ Se cargaron ${inspeccionesImages.length} im√°genes desde MCP`)
  } else {
    console.log('‚ö†Ô∏è  No se encontraron im√°genes en MCP (se cargar√°n posteriormente)')
  }

  const inspeccionesTopic = await prisma.topic.upsert({
    where: { slug: 'inspecciones-seguridad' },
    update: {
      contentJson: inspeccionesContent as any,
      estimatedMinutes: 60, // 10+10+12+13+15
      images: inspeccionesImages as any,
      imagesLoadedAt: inspeccionesImages.length > 0 ? new Date() : null
    },
    create: {
      title: 'Inspecciones de Seguridad',
      slug: 'inspecciones-seguridad',
      description: 'Aprende a planificar, ejecutar y documentar inspecciones de seguridad, clasificando hallazgos y estableciendo acciones correctivas seg√∫n normativa peruana',
      courseId: fundamentosCourse.id,
      instructorId: ssoInstructor.id,
      order: 2,
      estimatedMinutes: 60,
      difficulty: 'Intermedio',
      contentJson: inspeccionesContent as any,
      prerequisiteTopicIds: [ipercTopic.id] as any, // Requiere completar IPERC primero
      images: inspeccionesImages as any,
      imagesLoadedAt: inspeccionesImages.length > 0 ? new Date() : null,
      isPublished: true
    }
  })

  console.log('‚úÖ Tema Inspecciones de Seguridad creado')

  // 6. Crear usuario de prueba
  const testUser = await prisma.user.upsert({
    where: { email: 'estudiante@test.com' },
    update: {},
    create: {
      email: 'estudiante@test.com',
      name: 'Estudiante de Prueba',
      googleId: null
    }
  })

  console.log('‚úÖ Usuario de prueba creado')

  console.log('\nüéâ Seed completado!')
  console.log('\nDatos creados:')
  console.log(`- Carrera: ${ssoCareer.name}`)
  console.log(`- Instructor: ${ssoInstructor.name}`)
  console.log(`- Curso: ${fundamentosCourse.title}`)
  console.log(`- Temas:`)
  console.log(`  1. ${ipercTopic.title} (${ipercTopic.estimatedMinutes} min)`)
  console.log(`  2. ${inspeccionesTopic.title} (${inspeccionesTopic.estimatedMinutes} min)`)
  console.log(`- Usuario: ${testUser.email}`)
}

main()
  .catch((e) => {
    console.error('‚ùå Error en seed:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
